@model IEnumerable<foodary.Models.recipe>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Find recipe</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>


</head>


<body>
    <div class="container">
        <h1 class="banner_title">Find Recipe</h1>

        <p class="banner_text">
            There many simple and cheap recipes to help you save money, time and keep adequate nutrition.
        </p>
        <p class="banner_text" style="font-weight: bold; text-align: left;">
            Choose what type of meal you would like to cook
        </p>
        <div class="text-center">
            <button class="btn btn-filter-default" id="butNVegetarian">Non-vegetarian</button>
            <button class="btn btn-filter-active" id="butYVegetarian">Vegetarian</button>
        </div>
        <br />
        <p class="banner_text" style="font-weight: bold; text-align: left;">
            Select ingredients you would like to cook with
        </p>
        <div class="row my-3 text-center">
            <div class="row col-md-4">
                <div class="col-md-3">
                    <p>Meat</p>
                </div>
                <div class="col-md-9">
                    <select class="selectpicker" multiple="multiple" id="selMeat">
                        @if (ViewBag.MeatList != null && ViewBag.MeatList.Count > 0)
                        {
                            foreach (foodary.Models.product p in ViewBag.MeatList)
                            {
                                <option value="@p.name">@p.name</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="row col-md-4">
                <div class="col-md-3">
                    <p>Vegetables</p>
                </div>
                <div class="col-md-9">
                    <select class="selectpicker" multiple="multiple" id="selVegetables">
                        @if (ViewBag.VegetablesList != null && ViewBag.VegetablesList.Count > 0)
                        {
                            foreach (foodary.Models.product p in ViewBag.VegetablesList)
                            {
                                <option value="@p.name">@p.name</option>
                            }
                        }
                    </select>
                </div>
            </div>
            <div class="row col-md-4">
                <div class="col-md-3">
                    <p>Others</p>
                </div>
                <div class="col-md-9">
                    <select class="selectpicker" multiple="multiple" id="selOthers">
                        @if (ViewBag.OthersList != null && ViewBag.OthersList.Count > 0)
                        {
                            foreach (foodary.Models.product p in ViewBag.OthersList)
                            {
                                <option value="@p.name">@p.name</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="row my-3 text-center">
            <div class="col-md-4" id="divMeat">
            </div>
            <div class="col-md-4" id="divVegetables">
            </div>
            <div class="col-md-4" id="divOthers">
            </div>
        </div>
        <div class="text-center">
            <button class="btn btn-red" onclick="GetData();">Recommend Recipes</button>
        </div>
        <br />
        <p class="banner_text" style="font-weight: bold; text-align: left;">
            Recommended Recipes
        </p>
        <div class="row text-center col-md-8">
            <div class="col-md-3">
                <p>Sort By:</p>
            </div>
            <div class="col-md-3">
                <button class="btn btn-filter-default" id="butPreparationtime" onclick="GetSort('preparationTime')">Preparation time</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-filter-active" id="butCost" onclick="GetSort('cost')">Cost</button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-filter-default" id="butServingsize" onclick="GetSort('servingSize')">Serving size</button>
            </div>
        </div>
        <br />
        <div id="accordion">
        </div>
        <br />
    </div>
</body>
</html>
<script type="text/javascript">
    $(document).ready(function () {
        $("#butNVegetarian").click(function () { ChooseV(0); });
        $("#butYVegetarian").click(function () { ChooseV(1); });

        $('#selMeat').on('changed.bs.select', function () { SelectP('M', this) });
        $('#selVegetables').on('changed.bs.select', function () { SelectP('V', this) });
        $('#selOthers').on('changed.bs.select', function () { SelectP('O', this) });

        GetData();
    });

    var category = "vegetarian";
    function ChooseV(type) {
        if (type == 0) {
            category = "non-vegetarian";
            $("#butNVegetarian").removeClass("btn-filter-default");
            $("#butNVegetarian").addClass("btn-filter-active");

            $("#butYVegetarian").removeClass("btn-filter-active");
            $("#butYVegetarian").addClass("btn-filter-default");
        } else {
            category = "vegetarian";
            $("#butNVegetarian").removeClass("btn-filter-active");
            $("#butNVegetarian").addClass("btn-filter-default");

            $("#butYVegetarian").removeClass("btn-filter-default");
            $("#butYVegetarian").addClass("btn-filter-active");
        }
    }
    function SelectP(type, sel) {

        var list = $(sel).val();
        if (list != null && list.length > 0) {
            var str = '';
            for (var i = 0; i < list.length; ++i) {
                str += '<span class="col-md-6 tile-product py-1">' + list[i] + '</span><br />'
            }
            switch (type) {
                case "M":
                    $("#divMeat").html("");
                    $("#divMeat").html(str);
                    break;
                case "V":
                    $("#divVegetables").html("");
                    $("#divVegetables").html(str);
                    break;
                case "O":
                    $("#divOthers").html("");
                    $("#divOthers").html(str);
                    break;
            }
        } else {
            switch (type) {
                case "M":
                    $("#divMeat").html("");
                    break;
                case "V":
                    $("#divVegetables").html("");
                    break;
                case "O":
                    $("#divOthers").html("");
                    break;
            }
        }
    }

    var sort = "cost";
    function GetSort(s) {
        sort = s;
        switch (sort) {
            case "preparationTime":
                $("#butPreparationtime").removeClass("btn-filter-default");
                $("#butPreparationtime").addClass("btn-filter-active");

                $("#butCost").removeClass("btn-filter-active");
                $("#butCost").addClass("btn-filter-default");

                $("#butServingsize").removeClass("btn-filter-active");
                $("#butServingsize").addClass("btn-filter-default");
                break;
            case "cost":
                $("#butCost").removeClass("btn-filter-default");
                $("#butCost").addClass("btn-filter-active");

                $("#butPreparationtime").removeClass("btn-filter-active");
                $("#butPreparationtime").addClass("btn-filter-default");

                $("#butServingsize").removeClass("btn-filter-active");
                $("#butServingsize").addClass("btn-filter-default");
                break;
            case "servingSize":
                $("#butServingsize").removeClass("btn-filter-default");
                $("#butServingsize").addClass("btn-filter-active");

                $("#butCost").removeClass("btn-filter-active");
                $("#butCost").addClass("btn-filter-default");

                $("#butPreparationtime").removeClass("btn-filter-active");
                $("#butPreparationtime").addClass("btn-filter-default");
                break;
        }
        GetData();
    }

    function GetData() {
        var keys = [];
        //获得key
        var mlist = $("#selMeat").val();
        if (mlist != null && mlist.length > 0) {
            for (var i = 0; i < mlist.length; ++i) {
                keys.push(mlist[i]);
            }
        }
        var vlist = $("#selVegetables").val();
        if (vlist != null && vlist.length > 0) {
            for (var i = 0; i < vlist.length; ++i) {
                keys.push(vlist[0]);
            }
        }
        var olist = $("#selOthers").val();
        if (olist != null && olist.length > 0) {
            for (var i = 0; i < olist.length; ++i) {
                keys.push(olist[i]);
            }
        }

        $.ajax({
            type: "POST",
            url: "/Home/GetFoodaryData",
            data: { category: category, keys: keys, sort: sort },
            dataType: "json",
            success: function (data) {
                $('#accordion').empty();
                var html = '';
                $.each(data, function (i, item) {
                    html += "<div class=\"card\">";
                    html += "<div class=\"card-header\" id=\"heading" + i + "\">";
                    html += "<h5 class=\"mb-0\">";
                    html += "<button class=\"btn btn-link\" data-toggle=\"collapse\" data-target=\"#collapse" + i + "\" aria-expanded=\"true\" aria-controls=\"collapse" + i + "\">";
                    html += (i + 1) + ". " + item.recipe_name;
                    html += "</button>";
                    html += "</h5>";
                    html += "</div>";
                    html += "<div id=\"collapse" + i + "\" class=\"collapse  \" aria-labelledby=\"heading" + i + "\" data-parent=\"#accordion\" style=\"\">";
                    html += "<div class=\"card-body\">";
                    html += "<img src=\"" + item.img_url + "\" style=\"width:800px;\">";
                    html += "<table class=\"table table-map display text-center\" id=\"table" + i + "\" cellspacing=\"0\" width=\"100%\" style=\"margin-top: 2em\">";
                    html += "<thead>";
                    html += "<tr>";
                    html += "<th>";
                    html += "Servings";
                    html += "</th>";
                    html += "<th>";
                    html += "Preparation time";
                    html += "</th>";
                    html += "<th>";
                    html += "Approximate cost";
                    html += "</th>";
                    html += "</tr>";
                    html += "</thead>";
                    html += "<thead>";
                    html += "</thead>";
                    html += "<tbody class=\"names\">";
                    html += "<tr>";
                    html += "<th>" + item.servings + "</th>";
                    html += "<th>" + item.total_time_str + "</th>";
                    html += "<th>$" + item.cost + "</th>";
                    html += "</tr>";
                    html += "<tr>";
                    html += "<th width=\"60%\">";
                    html += "Ingredients";
                    html += "<div class=\"text-left\">";

                    var strs = item.ingredients.split("**");
                    for (j = 0; j < strs.length; j++) {
                        if (strs[j].length > 0) {
                            html += "<p>| " + strs[j] + "</p>";
                        }
                    }

                    html += "</div>";
                    html += "</th>";
                    html += "<th colspan=\"2\">";
                    html += "Directions";
                    html += "<div class=\"text-left\">";

                    var strs = item.directions.split("**");
                    for (j = 0; j < strs.length; j++) {
                        if (strs[j].length > 0) {
                            html += "<p>| Step " + (j + 1) + " " + strs[j] + "</p>";
                        }
                    }

                    html += "</div>";
                    html += "</th>";
                    html += "</tr>";
                    html += "</tbody>";
                    html += "</table>";
                    html += "</div>";
                    html += "</div>";
                    html += "</div>";
                });
                $('#accordion').html(html);
            }
        });

    }

</script>