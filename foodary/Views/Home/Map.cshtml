@model IEnumerable<foodary.Models.FoodEventSet>

@{
    ViewBag.Title = "Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <meta http-equiv="content-type" content="text/html; charset=gb2312" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="~/css/jquery.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBB60Ip9iv28WTdf-vLI1guI2wM0GxyS5Y" type="text/javascript"></script>
</head>
<body>
    <div class="container" style="margin-top:100px">
        <div class="row my-sm-3" style="height:auto">
            <div class="col-md-2 py-1 tile-padding-8">
            </div>
            <div class="col-md-8 py-1 tile-padding-8">
                <h1 class="card_title" style="font-weight: bold; color: #0277bd; font-size:35px">FIND FREE MEALS IN MELBOURNE!</h1>
            </div>
            <div class="col-md-2 py-1 tile-padding-8" style="cursor:pointer;">
                <center>
                    <img src="~/images/locate1.png" />
                    <button type="button" style="width:150px;height:40px;border:3px black solid;background-color:white; cursor:pointer;" onclick="getLocation()">Locate me</button>
                </center>
            </div>
        </div>
        <center>
            <p style="font-size:18px; font-weight:bold;">Lots of places in Melbourne provide free food to the community in the form of Food Parcels, Community meals, Open Tables, etc</p>
        </center>
        <hr />
        <div class="row my-3 food-categories">
            <div class="col-md-3 py-1 tile-padding-8">
                <div id="tile-all" class="tile-active tile text-center type" style="cursor:pointer; ">
                    <img src="~/images/vegetablesmall.png" alt="Card image cap" />
                    <div>
                        <p>Show all</p>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8">
                <div id="tile-food-parcel" class="tile text-center type" style="cursor:pointer; ">
                    <img src="~/images/food-parcel.png" alt="Card image cap" />
                    <div>
                        <p>Food parcel</p>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8" style="cursor:pointer;">
                <div id="tile-community-meal" class="tile text-center type">
                    <img src="~/images/community-meal.png" alt="Card image cap" />
                    <div>
                        <p>Community meal</p>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8" style="cursor:pointer;">
                <div id="tile-food-van" class="tile text-center type">
                    <img src="~/images/food-van.png" alt="Card image cap" />
                    <div>
                        <p>Food van</p>
                    </div>
                    <br />
                </div>
            </div>
        </div>

        <div class="row my-3">
            <div id="googleMap" style="height: 400px; width: 100%"></div>

            <div class="col-md-12">
                <br />
                <table class="table table-map display" id="table" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>
                                Name  (click on the <img style="cursor:pointer;" src="~/images/pin.png" /> to locate events)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Phone)
                            </th>
                            <th>
                                Business Hours
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Cost)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Category)
                            </th>
                        </tr>
                    </thead>

                    <tbody class="names">
                        @foreach (var item in Model)
                        {
                            int count = 0;

                            <tr>
                                <td id="name">
                                    @Html.DisplayFor(modelItem => item.Name)<br />
                                    <img style="cursor:pointer;" src="~/images/pin.png" onclick="showEventPosition(@Html.DisplayFor(modelItem => item.Id))" /> @Html.DisplayFor(modelItem => item.Id) @Html.DisplayFor(modelItem => item.Address),
                                    @Html.DisplayFor(modelItem => item.Suburb)
                                </td>
                                <td id="phone">
                                    @Html.DisplayFor(modelItem => item.Phone)
                                </td>
                                <td id="schedule">
                                    @Html.DisplayFor(modelItem => item.Timetable)
                                </td>
                                <td id="cost">
                                    @Html.DisplayFor(modelItem => item.Cost)
                                </td>
                                <td id="Category">
                                    @Html.DisplayFor(modelItem => item.Category)
                                </td>
                                @*<td>
                                    @Html.ActionLink("Details", "Details", new { id = item.Id }) |
                                </td>*@
                            </tr>
                            count = count + 1;
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div id="food" style="display:none">
            @foreach (var item in Model)
            {
                <div id="locations">
                    <p id="name">@Html.DisplayFor(modelItem => item.Name)</p>
                </div>}
        </div>


        <div id="Time" style="display:none">
            @foreach (var item in Model)
            {
                <div id="locations">
                    <p id="time">@Html.DisplayFor(modelItem => item.Timetable)</p>
                </div>}
        </div>

        <script type="text/javascript" charset="utf8" src="~/js/jquery.min.js"></script>
        <!-- DataTables -->
        <script type="text/javascript" charset="utf8" src="~/js/jquery.dataTables.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                $("#tile-all").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-all").addClass("tile-active");
                });
                $("#tile-food-parcel").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-food-parcel").addClass("tile-active");
                });
                $("#tile-community-meal").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-community-meal").addClass("tile-active");
                });
                $("#tile-food-van").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-food-van").addClass("tile-active");
                });

                $('#table').DataTable({
                    sScrollX: true,
                    initComplete: function () {
                        var api = this.api();
                       this.api().columns([3,4]).every( function (i) {
                            var column = api.column(i);
                            var select = $('<select><option value=""></option></select>')
                                .appendTo( $(column.header()))
                                .on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex(
                                        $(this).val()
                                    );
                                    column
                                        .search(val ? '^' + val + '$' : '', true, false)
                                        .draw();
                                });
                            column.data().unique().sort().each(function (d, j) {
                                select.append('<option value="' + d + '">' + d.substr(0,8) + '</option>')
                            });

                        });
                    }
                });

                getData("Show all");
            });


            var locations = [];
            var names = [];
            var times = [];
            var mapPin = {
                url: "/images/restlogo.png", // url
                scaledSize: new google.maps.Size(30, 30), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var data = JSON.parse('@ViewBag.data');

            function getData(SearchString) {
                $.ajax({
                    url: '/Home/GetData',
                    method: 'post',
                    data: { 'SearchString': SearchString },
                    success: function (data) {
                        var obj = JSON.parse(data);
                        locations = [];
                        names = [];
                        times = [];
                        for (var i = 0; i < obj.length; i++) {
                            var point = {
                                "lat": obj[i]["Latitude"],
                                "lng": obj[i]["Longitude"],
                            };
                            locations.push(point);
                            names.push(obj[i]["Name"]);
                            times.push(obj[i]["Timetable"]);
                        };
                        initialize();
                    },
                })
            }

            $(".type").click(function (e) {
                var selectedType = $(this).find('p').html();
                getPin(selectedType);
                getData(selectedType);
            });

            function getPin(selectedType) {
                var imgUrl = "/images/restlogo.png";
                if (selectedType == "Show all") {
                    imgUrl = "/images/restlogo.png";
                } else if (selectedType == "Food parcel") {
                    imgUrl = "/images/foodicon2.png";
                } else if (selectedType == "Community meal") {
                    imgUrl = "/images/food1.png";
                } else if (selectedType == "Food van") {
                    imgUrl = "/images/foodicon3.png";
                }

                mapPin = {
                    url: imgUrl, // url
                    scaledSize: new google.maps.Size(30, 30), // scaled size
                    origin: new google.maps.Point(0, 0), // origin
                    anchor: new google.maps.Point(0, 0) // anchor
                };
            }

            // 初始化地图
            function initialize() {
                var mapProp = {
                    center: new google.maps.LatLng(-37.822, 144.95),
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

                locations.map(function (location, i) {
                    var point = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: names[i],
                        icon: mapPin
                    });

                    iw = new google.maps.InfoWindow;

                    google.maps.event.addListener(point, "click", function (e) {
                        iw.setContent("<div><p>Event name:" + names[i] + "</p><p>Event Time：" + times[i] + "</p></div>")
                        iw.open(map, point);
                    });
                    return point;
                });
            };
            google.maps.event.addDomListener(window, 'load', initialize);

            var x = document.getElementById("demo");
            function getLocation() {
                alert('ddd');
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                }
                else { x.innerHTML = "Geolocation is not supported by this browser."; }
            };
            function showPosition(position) {

                map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));

                var iconImage = {
                    url: "/images/yourlocation_foodary.png", // url
                    scaledSize: new google.maps.Size(50, 50), // scaled size
                    origin: new google.maps.Point(0, 0), // origin
                    anchor: new google.maps.Point(0, 0) // anchor
                };
                new google.maps.Marker({
                    position: { lat: position.coords.latitude, lng: position.coords.longitude },
                    map: map,
                    title: "Current location",
                    icon: iconImage,

                });
            };
            function showEventPosition(id) {

                map.setCenter(new google.maps.LatLng(data[0][id-1], data[1][id-1])),
                    map.setZoom(16);
            }
        </script>


    </div>


</body>

</html>

