@model IEnumerable<foodary.Models.FoodEventSet>

@{
    ViewBag.Title = "Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=gb2312" />
    <link href="~/DataTables-1.10.21/media/css/dataTables.bootstrap.css" rel="stylesheet" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="~/css/jquery.dataTables.css" />


    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBB60Ip9iv28WTdf-vLI1guI2wM0GxyS5Y" type="text/javascript"></script>
</head>
<body onload="load()" onunload="GUnload()">
    <div class="container" style="padding-top:6em;">
        <h1 class="banner_title" style="font-family:PoiretOne-Regular; font-weight: bold">Food availability</h1>
        <p class="banner_text">Lots of places in Melbourne provide free food to the community in<br /> the form of Food Parcels, Community meals, Open Tables, etc</p>
        <h1 class="card_title" style="font-family:PoiretOne-Regular; font-weight: bold; color: #0277bd">FIND FREE MEALS IN VICTORIA!</h1>
        <div class="row my-3">
            <div class="col-md-4 py-1 tile-padding-8">
                <div class="tile text-center" onclick="getLocation()">
                    <img src="~/images/food-parcel.png" alt="Card image cap" />
                    <div>
                        <p>Food parcel</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 py-1 tile-padding-8">
                <div class="tile text-center">
                    <img src="~/images/community-meal.png" alt="Card image cap" />
                    <div>
                        <p>Community meal</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 py-1 tile-padding-8">
                <div class="tile text-center">
                    <img src="~/images/food-van.png" alt="Card image cap" />
                    <div>
                        <p>Food van</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-3">
            <div class="col-md-12 py-1">
                <form>
                    <div class="input-group padding-25">
                        <input type="text" class="search-input form-control" placeholder="Fitzroy" />
                        <div class="input-group-btn">
                            <button class="btn btn-default search-button" type="submit">
                                GO!
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="row my-3">
            <button onclick="getLocation()">Get your location</button>
        </div>
        <div class="row my-3">
            <div id="googleMap" style="height: 400px; width: 100%"></div>
            <div class="col-md-12">
                <table class="table table-map" id="table">
                    <thead style="display:none">
                        <tr>
                            <th>
                                @Html.DisplayNameFor(model => model.Name)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Phone)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Monday)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Cost)
                            </th>
                        </tr>
                    </thead>
                    <tbody class="names">
                        @foreach (var item in Model)
                        {
                            int count = 0;

                            <tr>
                                <td id="name">
                                    @Html.DisplayFor(modelItem => item.Name)<br />
                                    <img src="~/images/pin.png" onclick="showEventPosition(@Html.DisplayFor(modelItem => item.Id))" /> @Html.DisplayFor(modelItem => item.Id) @Html.DisplayFor(modelItem => item.Address),
                                    @Html.DisplayFor(modelItem => item.Suburb)
                                </td>
                                <td id="phone">
                                    @Html.DisplayFor(modelItem => item.Phone)
                                </td>
                                <td id="schedule">
                                    @Html.DisplayFor(modelItem => item.Timetable)
                                </td>
                                <td id="cost">
                                    @Html.DisplayFor(modelItem => item.Cost)<br />
                                    @Html.DisplayFor(modelItem => item.Category)
                                </td>
                            </tr>
                            count = count+1;
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div id="food" style="display:none">
            @foreach (var item in Model)
            {
                <div id="locations">
                    <p id="name">@Html.DisplayFor(modelItem => item.Name)</p>
                </div>}
        </div>
        <script src="~/js/bootstrap.min.js"></script>
        <script type="text/javascript" charset="utf8" src="~/js/jquery.min.js"></script>
        <!-- DataTables -->
        <script type="text/javascript" charset="utf8" src="~/js/jquery.dataTables.js"></script>
        <script type="text/javascript">
        $(document).ready(function () {
            $('#table').DataTable({
                sScrollX: true
            });
        });

        var names = [];
        var item = document.getElementById("food");
        var itemson = item.getElementsByTagName('div');
        for (var i = 0; i < itemson.length; i++) {
            var itemGson = itemson[i].getElementsByTagName('p');
            for (var a = 0; a < itemGson.length; a++) {
                var name = itemGson[a].innerText;
                names.push(name);
            }
        }
            var data = JSON.parse('@ViewBag.data');
            var locations = [];
            for (var i = 0; i < 50; i++) {
                var point = {
                    "lat": data[0][i],
                    "lng": data[1][i],
                };
                locations.push(point);
            }
        // 初始化地图
        function initialize() {

            var mapProp = {
                center: new google.maps.LatLng(-37.822, 144.95),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

            

            // Push them all into an array.
            //var img = "/images/rest_foodary.png"

            var img = {
                url: "/images/restlogo.png", // url
                scaledSize: new google.maps.Size(30, 30), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var markers = locations.map(function (location, i) {
                return new google.maps.Marker({
                    position: location,
                    map: map,
                    title: names[i],
                    icon: img
                });
            });

        };
        google.maps.event.addDomListener(window, 'load', initialize);

        var x = document.getElementById("demo");
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
            else { x.innerHTML = "Geolocation is not supported by this browser."; }
        };
            function showPosition(position) {

            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));

            var iconImage = {
                url: "/images/yourlocation_foodary.png", // url
                scaledSize: new google.maps.Size(50, 50), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var marker = new google.maps.Marker({
                position: { lat: position.coords.latitude, lng: position.coords.longitude },
                map: map,
                title: "Cureent location",
                icon: iconImage,

            });
            };
            function showEventPosition(id) {
         
                map.setCenter(new google.maps.LatLng(data[0][id-1], data[1][id-1])),
                    map.setZoom(16);
            }
        </script>
    </div>
</body>
</html>

