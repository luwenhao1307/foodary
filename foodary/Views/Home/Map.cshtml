@model IEnumerable<foodary.Models.FoodEventSet>

@{
    ViewBag.Title = "Map";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <meta http-equiv="content-type" content="text/html; charset=gb2312" />
    <link href="~/DataTables-1.10.21/media/css/dataTables.bootstrap.css" rel="stylesheet" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="~/css/jquery.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBB60Ip9iv28WTdf-vLI1guI2wM0GxyS5Y" type="text/javascript"></script>
</head>
<body onload="load()" onunload="GUnload()">
    <div class="container">
        <div class="row my-sm-3" style="height:auto">
            <div class="col-md-2 py-1 tile-padding-8">
            </div>
            <div class="col-md-8 py-1 tile-padding-8">
                <h1 class="card_title" style="font-weight: bold; color: #0277bd; font-size:35px">FIND FREE MEALS IN MELBOURNE!</h1>
            </div>
            <div class="col-md-2 py-1 tile-padding-8" style="cursor:pointer;">
                <center>
                    <img src="~/images/locate1.png" />
                    <button type="button" style="width:150px;height:40px;border:3px black solid;background-color:white; cursor:pointer;" onclick="getLocation()">Locate me</button>
                </center>
            </div>
        </div>
        <center>
            <p style="font-size:18px; font-weight:bold;">Lots of places in Melbourne provide free food to the community in the form of Food Parcels, Community meals, Open Tables, etc</p>
        </center>
        <hr />
        <div class="row my-3 food-categories">
            <div class="col-md-3 py-1 tile-padding-8">
                <div id="tile-all" class="tile-active tile text-center type" style="cursor:pointer; ">
                    <img src="~/images/vegetablesmall.png" alt="Card image cap" />
                    <div>
                        <paa>Show all</paa>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8">
                <div id="tile-food-parcel" class="tile text-center type" style="cursor:pointer; ">
                    <img src="~/images/food-parcel.png" alt="Card image cap" />
                    <div>
                        <pa>Food parcel</pa>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8" style="cursor:pointer;">
                <div id="tile-community-meal" class="tile text-center type">
                    <img src="~/images/community-meal.png" alt="Card image cap" />
                    <div>
                        <pb>Community meal</pb>
                    </div>
                    <br />
                </div>
            </div>
            <div class="col-md-3 py-1 tile-padding-8" style="cursor:pointer;">
                <div id="tile-food-van" class="tile text-center type">
                    <img src="~/images/food-van.png" alt="Card image cap" />
                    <div>
                        <pc>Food van</pc>
                    </div>
                    <br />
                </div>
            </div>
        </div>

        <!--<div class="row my-3">
    <div class="col-md-12 py-1">
        <form>-->
        @*<div class="input-group padding-25">
            <input type="text" class="search-input form-control" placeholder="Fitzroy" />
            <div class="input-group-btn">
                <button class="btn btn-default search-button" type="submit">
                    GO!
                </button>
            </div>
        </div>*@
        <!--</form>
        </div>
    </div>-->
        @*<div class="row my-3">
            <div class="col-md-2 py-1 tile-padding-8">
                <button type="button" style="width:150px;height:40px;border:3px orange double;background-color:white;" onclick="showAll()" width="50px">Show all</button>
            </div>
        </div>*@

        <div class="row my-3">
            <div id="googleMap" style="height: 400px; width: 100%"></div>

            <div class="col-md-12">
                <br />
                <table class="table table-map display" id="table" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>
                                Name  (click on the <img style="cursor:pointer;" src="~/images/pin.png" /> to locate events)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Phone)
                            </th>
                            <th>
                                Business Hours
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Cost)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Category)
                            </th>
                        </tr>
                    </thead>

                    <tbody class="names">
                        @foreach (var item in Model)
                        {
                            int count = 0;

                            <tr>
                                <td id="name">
                                    @Html.DisplayFor(modelItem => item.Name)<br />
                                    <img style="cursor:pointer;" src="~/images/pin.png" onclick="showEventPosition(@Html.DisplayFor(modelItem => item.Id))" /> @Html.DisplayFor(modelItem => item.Id) @Html.DisplayFor(modelItem => item.Address),
                                    @Html.DisplayFor(modelItem => item.Suburb)
                                </td>
                                <td id="phone">
                                    @Html.DisplayFor(modelItem => item.Phone)
                                </td>
                                <td id="schedule">
                                    @Html.DisplayFor(modelItem => item.Timetable)
                                </td>
                                <td id="cost">
                                    @Html.DisplayFor(modelItem => item.Cost)
                                </td>
                                <td id="Category">
                                    @Html.DisplayFor(modelItem => item.Category)
                                </td>
                                @*<td>
                                    @Html.ActionLink("Details", "Details", new { id = item.Id }) |
                                </td>*@
                            </tr>
                            count = count + 1;
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div id="food" style="display:none">
            @foreach (var item in Model)
            {
                <div id="locations">
                    <p id="name">@Html.DisplayFor(modelItem => item.Name)</p>
                </div>}
        </div>


        <div id="Time" style="display:none">
            @foreach (var item in Model)
            {
                <div id="locations">
                    <p id="time">@Html.DisplayFor(modelItem => item.Timetable)</p>
                </div>}
        </div>

        <script src="~/js/bootstrap.min.js"></script>
        <script type="text/javascript" charset="utf8" src="~/js/jquery.min.js"></script>
        <!-- DataTables -->
        <script type="text/javascript" charset="utf8" src="~/js/jquery.dataTables.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                $("#tile-all").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-all").addClass("tile-active");
                });
                $("#tile-food-parcel").click(function () {
                    console.log("food parcel");
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-food-parcel").addClass("tile-active");
                });
                $("#tile-community-meal").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-community-meal").addClass("tile-active");
                });
                $("#tile-food-van").click(function () {
                    $(".food-categories").find(".tile-active").removeClass("tile-active");
                    $("#tile-food-van").addClass("tile-active");
                });
                $('#table').DataTable({
                    sScrollX: true,
                    initComplete: function () {
                        var api = this.api();
                       this.api().columns([3,4]).every( function (i) {
                            var column = api.column(i);
                            var select = $('<select><option value=""></option></select>')
                                .appendTo( $(column.header()))
                                .on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex(
                                        $(this).val()
                                    );
                                    column
                                        .search(val ? '^' + val + '$' : '', true, false)
                                        .draw();
                                });
                            column.data().unique().sort().each(function (d, j) {
                                select.append('<option value="' + d + '">' + d.substr(0,8) + '</option>')
                            });

                        });
                    }
                });

            });


            var names = [];
            var namesSta = [];
                var item = document.getElementById("food");
                var itemson = item.getElementsByTagName('div');
                for (var i = 0; i < itemson.length; i++) {
                    var itemGson = itemson[i].getElementsByTagName('p');
                    for (var a = 0; a < itemGson.length; a++) {
                        var name = itemGson[a].innerText;
                        names.push(name);
                        namesSta.push(name);
                    }
            }

            var tames = [];
            var tamesSta = [];
            var titem = document.getElementById("Time");
            var titemson = titem.getElementsByTagName('div');
            for (var i = 0; i < titemson.length; i++) {
                var titemGson = titemson[i].getElementsByTagName('p');
                for (var a = 0; a < titemGson.length; a++) {
                    var tame = titemGson[a].innerText;
                    tames.push(tame);
                    tamesSta.push(tame);
                }
            }

            var data = JSON.parse('@ViewBag.data');
            var locations = [];//标点数组
            var location0 = [];//标点数组
            var location1 = [];//标点数组
            var location2 = [];//标点数组


            var locationSta = [];
                for (var i = 0; i < 50; i++) {
                    var point = {
                        "lat": data[0][i],
                        "lng": data[1][i],
                    };
                    locations.push(point);
                    locationSta.push(point);
            };

            function showAll() {
               locations = locationSta;
                names = namesSta;
                tames = tamesSta;
                location0 = [];
                location1 = [];
                location2 = [];
               initialize();
                };


            $(".type").click(function (e) {
                $.ajax(
                    {
                        url: '/Home/GetData',
                        method: 'post',
                        data: data,
                        success: function (data) {
                            var new1 = JSON.parse(data);
                            locations = [];
                            names = [];
                            for (var i = 0; i < new1.length; i++) {
                                var point = {
                                    "lat": new1 [i]["Latitude"],
                                    "lng": new1 [i]["Longitude"],
                                };
                                locations.push(point);
                                names.push(new1 [i]["Name"]);
                            };
                            initialize();
                        },
                    })
            });
            $(".type").click(function (e) {
                var SearchString = $(this).find('paa').html();
                $.ajax(
                    {
                        url: '/Home/GetData',
                        method: 'post',
                        data: { 'SearchString': SearchString },
                        success: function (data) {
                            var new1 = JSON.parse(data);
                            locations = [];
                            names = [];
                            for (var i = 0; i < new1.length; i++) {
                                var point = {
                                    "lat": new1[i]["Latitude"],
                                    "lng": new1[i]["Longitude"],
                                };
                                locations.push(point);
                                names.push(new1[i]["Name"]);
                            };
                            initialize();
                        },
                    })
            });

            $(".type").click(function (e) {
                var SearchString = $(this).find('pa').html();
                $.ajax(
                    {
                        url: '/Home/GetData',
                        method: 'post',
                        data: { 'SearchString': SearchString },
                        success: function (data) {
                            var new1 = JSON.parse(data);
                            locations0 = [];
                            names = [];
                            for (var i = 0; i < new1.length; i++) {
                                var point = {
                                    "lat": new1[i]["Latitude"],
                                    "lng": new1[i]["Longitude"],
                                };
                                locations0.push(point);
                                names.push(new1[i]["Name"]);
                            };
                            initialize();
                        },
                    })
            });


                $(".type").click(function (e) {
                    var SearchString = $(this).find('pb').html();
                    $.ajax(
                        {
                            url: '/Home/GetData',
                            method: 'post',
                            data: { 'SearchString': SearchString },
                            success: function (data) {
                                var new1 = JSON.parse(data);
                                location1 = [];
                                names = [];
                                for (var i = 0; i < new1.length; i++) {
                                    var point = {
                                        "lat": new1[i]["Latitude"],
                                        "lng": new1[i]["Longitude"],
                                    };
                                    location1.push(point);
                                    names.push(new1[i]["Name"]);
                                };
                                initialize();
                            },
                        })
                });

            $(".type").click(function (e) {
                var SearchString = $(this).find('pc').html();
                $.ajax(
                    {
                        url: '/Home/GetData',
                        method: 'post',
                        data: { 'SearchString': SearchString },
                        success: function (data) {
                            var new1 = JSON.parse(data);
                            location2 = [];
                            names = [];
                            for (var i = 0; i < new1.length; i++) {
                                var point = {
                                    "lat": new1[i]["Latitude"],
                                    "lng": new1[i]["Longitude"],
                                };
                                location2.push(point);
                                names.push(new1[i]["Name"]);
                            };
                            initialize();
                        },
                    })
            });


        // 初始化地图
            function initialize() {
            
            var mapProp = {
                center: new google.maps.LatLng(-37.822, 144.95),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("googleMap"), mapProp);



            // Push them all into an array.
            //var img = "/images/rest_foodary.png"

            var img = {
                url: "/images/restlogo.png", // url
                scaledSize: new google.maps.Size(30, 30), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };

            var imga = {
                url: "/images/foodicon2.png", // url
                scaledSize: new google.maps.Size(35, 35), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var imgb = {
                url: "/images/food1.png", // url
                scaledSize: new google.maps.Size(35, 35), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var imgc = {
                url: "/images/foodicon3.png", // url
                scaledSize: new google.maps.Size(35, 35), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };

         
            var marker = locations.map(function (location, i) {
                var point = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: names[i],
                    icon: img
                });
                var prev_infowindow = null;
                //---------自定义信息窗口显示-----------
                iw = new google.maps.InfoWindow;
                //点击信息窗口显示
                google.maps.event.addListener(point, "click", function (e) {
                    iw.setContent("<div><p>Event name:" + names[i] + "</p><p>Event Time：" + tames[i] + "</p></div>")
                    iw.open(map, point);
                });
                return point;
            });


            var markers = locations0.map(function (location, i) {
                var point = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: names[i],
                    icon: imga
                });
                var prev_infowindow;
                //---------自定义信息窗口显示-----------
                iw = new google.maps.InfoWindow;
                //点击信息窗口显示
                google.maps.event.addListener(point, "click", function (e) {
                    iw.setContent("<div><p>Event name:" + names[i] + "</p><p>Event Time：" + tames[i] + "</p></div>")
                    iw.open(map, point);
                });
                
                return point;
            });

            var markers1 = location1.map(function (location, i) {
                var point = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: names[i],
                    icon: imgb
                });
                var prev_infowindow;
                //---------自定义信息窗口显示-----------
                iw = new google.maps.InfoWindow;
                //点击信息窗口显示
                google.maps.event.addListener(point, "click", function (e) {
                    iw.setContent("<div><p>Event name:" + names[i] + "</p><p>Event Time：" + tames[i] + "</p></div>")
                    iw.open(map, point);
                });
                
                return point;
            });

            var markers2 = location2.map(function (location, i) {
                var point = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: names[i],
                    icon: imgc
                });
                var prev_infowindow;
                //---------自定义信息窗口显示-----------
                iw = new google.maps.InfoWindow;
                //点击信息窗口显示
                google.maps.event.addListener(point, "click", function (e) {
                    iw.setContent("<div><p>Event name:" + names[i] + "</p><p>Event Time：" + tames[i] + "</p></div>")
                    iw.open(map, point);
                });
                return point;
            });



        };
        google.maps.event.addDomListener(window, 'load', initialize);

        var x = document.getElementById("demo");
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
            else { x.innerHTML = "Geolocation is not supported by this browser."; }
        };
            function showPosition(position) {

            map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));

            var iconImage = {
                url: "/images/yourlocation_foodary.png", // url
                scaledSize: new google.maps.Size(50, 50), // scaled size
                origin: new google.maps.Point(0, 0), // origin
                anchor: new google.maps.Point(0, 0) // anchor
            };
            var marker = new google.maps.Marker({
                position: { lat: position.coords.latitude, lng: position.coords.longitude },
                map: map,
                title: "Current location",
                icon: iconImage,

            });
            };
            function showEventPosition(id) {

                map.setCenter(new google.maps.LatLng(data[0][id-1], data[1][id-1])),
                    map.setZoom(16);
            }
        </script>


    </div>


</body>

</html>

